# openvpn-connector-to-server

**Уточнение: данный проект - специфическая библиотека, в связи с чем использование для иных проектов, кроме моего, невозможно.**

Библиотека с API-роутером для связи с сервером NodeJS и Redis. Реализует доступы по временным JWT-токенам авторизации.

**Важно:** данная инструкция актуальна на версию от ``v1.1`` до ``v1.2``.

## Установка

## Установка NodeJS версией 18 и выше

Для работы библиотеки необходим ``NodeJS`` версией 18 и выше.

Для установки, введите следующее:

```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
sudo apt install nodejs
```

Проверьте установленную версию:
```bash
node -v
```

Если вы видите ``v18.20.8`` или выше, значит установка прошла успешно.

### Установка сервера Redis

Сервер Redis используется в библиотеке для работы со временем активации конфигов и учётом их блокировки.

Произведите установку **Redis** на сервер:

```bash
# Для Ubuntu / Debian
sudo apt update
sudo apt install redis-server

# Для CentOS
sudo yum update -y
sudo yum install redis
```

После чего - включите **Redis**:

```bash
sudo systemctl enable redis
```

### Установка библиотеки

Для установки библиотеки **скачайте себе репозиторий** и перейдите **в скачанную папку**:

```text
git clone https://github.com/KlarDak/openvpn-connector-to-server

cd openvpn-connector-to-server/
```
Установите все зависимости:

```bash
npm install
```

Далее, создайте и заполните ``.env``-файл. Ниже представлен шаблон:

```text
# Адрес сервера
SERVER_ADDRESS=
# Порт сервера
SERVER_PORT=
# Секретный токен сервера
SECRET_TOKEN=
# Папка с конфиг-файлами
CONFIG_FOLDER=
# Ссылка на скрипт генерации конфиг-файлов (должен располагаться в папке /etc/openvpn/scripts/)
SCRIPT_FILE=
# Ссылка на файл-коннектор для OpenVPN
CONNECTOR_FILE=
# Имя отправляемого конфиг-файла (по-умолчанию)
DEFAULT_NAME_V1=
# Допустимые IP-адреса, с которых могут приходить запросы
ALLOWED_ACCESS=
# IP-адрес сервера Redis
REDIS_HOST=
# Порт сервера Redis
REDIS_PORT=
```

### Настройка прав доступа

Скрипт ``configurator.sh`` работает с автоматическим созданием, редактированием и удалением конфиг-файла.

Для его автоматической работы, необходимо **отключить** пароль для ``sudo``.

На версию API ``v1.1`` и её субверсии, рекомендуем загрузить файлы в директорию ``/etc/openvpn/scripts/``. Для этого переместите их из директории ``scripts``, находящейся в ``openvpn-connector-to-server/src/``.

**Важно: ни в коем случае не выполняйте данный скрипт от имени ``root`` пользователя!** Не смотря на то, что данный скрипт был проверен на безопасность, практика использования ``root``-пользователя для данных действий **недопустима** и является заведомо опасной!

Для разрешения выполнения скрипта без пароля, выполните следующее:

```bash
sudo visudo
```

В конец открывшегося файла добавьте следующие строки:
```bash
# Замените USER на имя вашего пользователя в системе
USER ALL=(ALL) NOPASSWD: /etc/openvpn/scripts/configurator.sh create *
USER ALL=(ALL) NOPASSWD: /etc/openvpn/scripts/configurator.sh delete *
```

После чего сохраните изменения и выйдите из редактора.

Проверьте работу файла, выполнив следующее:

```bash
# Сбросит "тайм-аут" авторизации в sudo
sudo -k

cd /etc/openvpn/scripts/
sudo ./configurator.sh create test
```

Если выполнение команды ``sudo`` для данного файла не запросит у вас пароль, значит вы сделали всё правильно.

### Запуск сервера

После выполнение всех вышеуказанных действий, запустите сервер:
```bash
node server.js
```
или
```bash
npm start
```

В консоль сервера должно быть выведено следующее сообщение:
```text
The server has been started!
```

**Если этого не произошло, проверьте:**
1. Открыт ли у вас порт, указанный в файле ``.env``.
2. Если порт открыт, убедитесь, что он не занят другим процессом.
3. Проверьте, была ли выполнена команда ``npm install`` и установлены ли все зависимости.
4. Если проблема с Redis, также проверьте, открыт ли у вас порт, указанный в ``.env``-файле и не занят ли другим процессом.

## Допустимые запросы

Под капотом реализована стандартная схема **GET / POST / PUT / DELETE**. Способ авторизации - **JWT-токен**.

### Виды эндпоинтов

Допустимы два варианта **эндпоинта:**

``/users/config`` - создание, удаление, обновление и получение конфиг-файла пользователя.

``/configs/check`` - работа со временем активации конфиг-файла: добавление, увеличение / уменьшение, удаление значений.

## Примеры запросов (для конфиг-файлов)

Получение ссылки на временный токен для скачивания конфиг-файла:
```http
GET /users/config/{token}
```

Создание конфиг-файла:
```http
POST /users/config
{
    "token": "{token}"
}
```

Удаление конфиг-файла:
```http
DELETE /users/config
{
    "token": "{token}"
}
```

## Пример запроса для скачивания конфиг-файла
Для выполнения запроса на скачивание файла, нужно сначала **запросить временный токен**, предназначенный для скачивания файла:

```bash
GET /users/config/{token}
```

В качестве ответа вы получите ``expToken``. Его нужно использовать для **GET-запроса** к ``/users/config/download``.

```bash
GET /users/config/download/{token}
```

## Примеры запросов (для времени работы)

**Важно:** время и в запросах, и в ответах указывается в **минутах**.

Если в поле ``time`` указано отрицательное значение, значит, что конфиг-файл на данный момент **не обслуживает** пользователя и **является заблокированным**.

Запрос оставшегося времени:
```bash
GET /configs/check/{token}
```

Увеличение / уменьшение времени ответа:
```http
POST /configs/check
{
    "token": "{token}",
    "time": 300
}
```

Удалить значение времени:
```http
DELETE /configs/check
{
    "token": "{token}"
}
```

## Уведомления об удачном выполнении функции

Следующие ответы возможны при выполнении тех или иных запросов:

### Для запросов по конфиг-файлам
```json
// Удачное получение или генерация файла
{"code": 200, "data": "Success", "expToken": "xxxxxx-xxxx-xxxx-xxxx"}

// Удачное удаление файла
{"code": 200, "status": "Deleted"}
```
### Для запросов по времени работы конфиг-файлов
```json
// Время работы конфиг-файла установлено или обновлено
{"code": 200, "status": "Uploaded"}

// Вывод времени работы конфиг-файла (время указано в минутах)
{"code": 200, "status": "Success", "time": 100}

// Значение, показывающее, что конфиг-файл просрочен и не работает на данный момент
{"code": 200, "status": "Success", "time": -1}

// Удаление записи о работе конфиг-файла в Redis
{"code": 200, "status": "Deleted"}
```

## Виды ошибок
Следующие варианты ошибок возможный при работе с сервером.

```json
// Ошибка декодирования токена
{"code": 400, "status": "Undefined auth-token"}

// Неправильный UUID
{"code": 400, "status": "Invalid UUID-token"}

// Ошибка генерации конфиг-файла - уже существует
{"code": 409, "status": "File was founded and not re-generate"}

// Неизвестная ошибка генерации конфиг-файла
{"code": 500, "status": "Failed to generate the config-file"}

// Конфиг-файл не был создан
{"code": 404, "status": "File was not created"}

// Ошибка с получением констант из файла окружения
{"code": 401, "status": "Error with config paths"} 

// Файл не найден 
{"code": 404, "status": "File not found"}

// Неизвестная ошибка при удалении конфиг-файла и его ключей
{"code": 500, "status": "Some error has been detected with drop this file. Check logs"}

// Доступ к серверу запрещён по IP-адресу
{"code": 403, "status": "Access not allowed!"}

// Скачивание файла недоступно на сейчас
{"code": 500, "status": "Download file is not available now"}

// Временный токен просрочен
{"code": 403, "status": "This token was expired"}

// Неизвестная ошибка при создании записи в Redis
{"code": 500, "status": "Unchecked error" }

// Нед данных о конфиг-файле в Redis
{"code": 404, "status": "The config was not founded"}

// Невалидные параметры времени
{"code": 400, "status": "Invalid time params" }

// Уведомление о просроченном конфиг-файле
{"code": 404, "status": "This config was expired"}
```
